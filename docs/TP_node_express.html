<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TP2 - Gestion d'√©v√©nements universitaires</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body {
  font-family: 'Segoe UI', Arial, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
}

#map {
  height: 400px;
  width: 100%;
  border-radius: 8px;
  margin-top: 10px;
}

#preview {
  max-width: 200px;
  margin-top: 10px;
  border-radius: 8px;
}

.event-card {
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.event-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 25px rgba(0,0,0,0.2);
}

#chatbox {
  height: 300px;
  overflow-y: auto;
  padding: 16px;
  background: #f9fafb;
  border-radius: 8px;
  margin-bottom: 12px;
}

.msg {
  display: flex;
  margin: 12px 0;
  align-items: flex-start;
}

.msg.user {
  justify-content: flex-end;
}

.msg.bot {
  justify-content: flex-start;
}

.bubble {
  padding: 10px 16px;
  border-radius: 16px;
  max-width: 70%;
  word-wrap: break-word;
}

.user .bubble {
  background: #667eea;
  color: white;
}

.bot .bubble {
  background: #e5e7eb;
  color: #1f2937;
}

.icon {
  font-size: 24px;
  margin: 0 8px;
}
</style>
</head>
<body class="p-6">

<div class="max-w-4xl mx-auto">
  
  <!-- Header -->
  <header class="bg-white rounded-lg shadow-lg p-6 mb-6">
    <h1 class="text-3xl font-bold text-purple-700 mb-2">TP2 - Interface de gestion d'√©v√©nements universitaires</h1>
    <p class="text-gray-600">Node.js + Express - Cr√©er, g√©rer et visualiser les √©v√©nements</p>
    <p class="text-sm text-gray-500 mt-2">üìÖ Publi√© le 11/01/2026 par Asma BAGHDADI</p>
  </header>

  <!-- Formulaire de cr√©ation -->
  <section class="bg-white rounded-lg shadow-lg p-6 mb-6">
    <h2 class="text-2xl font-bold text-gray-800 mb-4">Cr√©er un √©v√©nement</h2>
    
    <form id="eventForm" class="space-y-4">
      
      <!-- Titre -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Titre</label>
        <input 
          type="text" 
          id="titre" 
          name="titre"
          placeholder="Entrez le titre de l'√©v√©nement"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
          required
        >
      </div>

      <!-- Date -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
        <input 
          type="date" 
          id="date"
          name="date"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
          required
        >
      </div>

      <!-- Lieu -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Lieu</label>
        <input 
          type="text" 
          id="lieu"
          name="lieu"
          placeholder="Lieu de l'√©v√©nement"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
          required
        >
      </div>

      <!-- Description -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
        <textarea 
          id="description"
          name="description"
          rows="4"
          placeholder="Description de l'√©v√©nement"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
          required
        ></textarea>
      </div>

      <!-- Affiche de l'√©v√©nement -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Affiche de l'√©v√©nement</label>
        <input 
          type="file" 
          id="affiche"
          accept="image/*"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
        >
        <img id="preview" class="hidden mt-2 rounded-lg shadow">
        <p class="text-xs text-gray-500 mt-1">Format accept√© : JPG, PNG, GIF</p>
      </div>

      <!-- Fiche descriptive -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Fiche descriptive (PDF ou TXT)</label>
        <input 
          type="file" 
          id="fiche"
          accept=".pdf,.txt"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
        >
        <p class="text-xs text-gray-500 mt-1">Format accept√© : PDF, TXT</p>
      </div>

      <!-- Adresse de l'√©v√©nement -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Adresse de l'√©v√©nement</label>
        <input 
          type="text" 
          id="adresse"
          name="adresse"
          placeholder="Adresse compl√®te"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
        >
        <button 
          type="button"
          onclick="localiserAdresse()"
          class="mt-2 w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition"
        >
          Valider l'adresse
        </button>
      </div>

      <!-- Carte interactive -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Localisation sur la carte</label>
        <div id="map"></div>
        <p class="text-xs text-gray-500 mt-2">üìç Cliquez sur la carte pour s√©lectionner la localisation</p>
      </div>

      <!-- Bouton Enregistrer -->
      <button 
        type="submit"
        class="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition transform hover:scale-105"
      >
        Enregistrer l'√©v√©nement
      </button>

    </form>
  </section>

  <!-- R√©sum√© de l'√©v√©nement -->
  <section class="bg-white rounded-lg shadow-lg p-6 mb-6" id="resumeSection" style="display:none;">
    <h2 class="text-2xl font-bold text-gray-800 mb-4">R√©sum√© de l'√©v√©nement</h2>
    <div id="resume" class="bg-purple-50 p-4 rounded-lg"></div>
  </section>

  <!-- Liste des √©v√©nements -->
  <section class="bg-white rounded-lg shadow-lg p-6 mb-6">
    <h2 class="text-2xl font-bold text-gray-800 mb-4">Liste des √©v√©nements</h2>
    <ul id="eventsList" class="space-y-4"></ul>
  </section>

  <!-- Chatbot -->
  <section class="bg-white rounded-lg shadow-lg p-6">
    <h2 class="text-2xl font-bold text-gray-800 mb-4">ü§ñ Chatbot de l'√©v√©nement</h2>
    <div id="chatbox"></div>
    <div class="flex gap-2">
      <input 
        type="text" 
        id="question"
        placeholder="Posez votre question..."
        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
        onkeypress="if(event.key==='Enter') askBot()"
      >
      <button 
        onclick="askBot()"
        class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition"
      >
        Envoyer
      </button>
    </div>
  </section>

</div>

<script>
// ===== VARIABLES GLOBALES =====
let lat, lng;
let marker;
let eventsList = [];
let selectedEvent = null;

// ===== INITIALISATION DE LA CARTE =====
const map = L.map('map').setView([36.8, 10.18], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '¬© OpenStreetMap contributors'
}).addTo(map);

// Clic sur la carte pour placer un marqueur
map.on('click', function(e) {
  lat = e.latlng.lat;
  lng = e.latlng.lng;
  if (marker) map.removeLayer(marker);
  marker = L.marker([lat, lng]).addTo(map);
  document.getElementById('adresse').value = `Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}`;
});

// ===== G√âOLOCALISATION PAR ADRESSE =====
function localiserAdresse() {
  const adr = document.getElementById('adresse').value;
  if (!adr) {
    alert('‚ö†Ô∏è Veuillez entrer une adresse');
    return;
  }
  
  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${adr}`)
    .then(r => r.json())
    .then(d => {
      if(d.length > 0) {
        lat = d[0].lat;
        lng = d[0].lon;
        if(marker) map.removeLayer(marker);
        marker = L.marker([lat, lng]).addTo(map);
        map.setView([lat, lng], 14);
        alert('‚úÖ Adresse localis√©e avec succ√®s !');
      } else {
        alert('‚ùå Adresse introuvable');
      }
    })
    .catch(err => {
      console.error(err);
      alert('‚ùå Erreur lors de la g√©olocalisation');
    });
}

// ===== APER√áU DE L'AFFICHE =====
document.getElementById('affiche').addEventListener('change', () => {
  const file = document.getElementById('affiche').files[0];
  if(file) {
    const preview = document.getElementById('preview');
    preview.src = URL.createObjectURL(file);
    preview.classList.remove('hidden');
  }
});

// ===== SOUMISSION DU FORMULAIRE =====
document.getElementById('eventForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const formData = new FormData();
  formData.append('titre', document.getElementById('titre').value);
  formData.append('date', document.getElementById('date').value);
  formData.append('lieu', document.getElementById('lieu').value);
  formData.append('description', document.getElementById('description').value);
  formData.append('adresse', document.getElementById('adresse').value);
  formData.append('lat', lat || '');
  formData.append('lng', lng || '');
  
  const affiche = document.getElementById('affiche').files[0];
  if(affiche) formData.append('affiche', affiche);
  
  const fiche = document.getElementById('fiche').files[0];
  if(fiche) formData.append('fiche', fiche);

  try {
    const response = await fetch('http://localhost:3000/events', {
      method: 'POST',
      body: formData
    });
    
    const result = await response.json();
    
    if(response.ok) {
      alert('‚úÖ √âv√©nement cr√©√© avec succ√®s !');
      
      // Afficher le r√©sum√©
      document.getElementById('resume').innerHTML = `
        <div class="space-y-2">
          <h3 class="text-xl font-bold text-purple-700">${result.titre}</h3>
          <p><strong>üìÖ Date :</strong> ${result.date}</p>
          <p><strong>üìç Lieu :</strong> ${result.lieu}</p>
          <p><strong>üìù Description :</strong> ${result.description}</p>
          <p><strong>üó∫Ô∏è Adresse :</strong> ${result.adresse}</p>
        </div>
      `;
      document.getElementById('resumeSection').style.display = 'block';
      
      // R√©initialiser le formulaire
      document.getElementById('eventForm').reset();
      document.getElementById('preview').classList.add('hidden');
      
      // Recharger la liste
      loadEvents();
      
      // Scroll vers le r√©sum√©
      document.getElementById('resumeSection').scrollIntoView({ behavior: 'smooth' });
    } else {
      alert('‚ùå Erreur lors de la cr√©ation : ' + result.error);
    }
  } catch(err) {
    console.error(err);
    alert('‚ùå Erreur de connexion au serveur');
  }
});

// ===== CHARGEMENT DES √âV√âNEMENTS =====
async function loadEvents() {
  try {
    const res = await fetch('http://localhost:3000/events');
    eventsList = await res.json();
    
    const list = document.getElementById('eventsList');
    list.innerHTML = '';
    
    if(eventsList.length === 0) {
      list.innerHTML = '<p class="text-gray-500 italic">Aucun √©v√©nement pour le moment</p>';
      return;
    }
    
    eventsList.forEach(event => {
      const li = document.createElement('li');
      li.className = 'event-card bg-gradient-to-r from-purple-50 to-blue-50 p-4 rounded-lg border border-purple-200';
      li.innerHTML = `
        <div class="flex justify-between items-start">
          <div class="flex-1">
            <h3 class="text-lg font-bold text-purple-700">${event.titre}</h3>
            <p class="text-sm text-gray-600">üìÖ ${event.date} - üìç ${event.lieu}</p>
            <p class="text-gray-700 mt-2">${event.description}</p>
          </div>
          <button 
            onclick="deleteEvent('${event._id}')"
            class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition"
          >
            Supprimer
          </button>
        </div>
      `;
      list.appendChild(li);
    });
    
    // Initialiser le chatbot si ce n'est pas d√©j√† fait
    if(document.getElementById('chatbox').innerHTML === '') {
      addMsg("Bonjour ! Quel est le nom de l'√©v√©nement que vous voulez interroger ?", "bot");
    }
  } catch(err) {
    console.error(err);
    document.getElementById('eventsList').innerHTML = '<p class="text-red-500">‚ùå Erreur de chargement</p>';
  }
}

// ===== SUPPRESSION D'UN √âV√âNEMENT =====
async function deleteEvent(id) {
  if(!confirm('√ätes-vous s√ªr de vouloir supprimer cet √©v√©nement ?')) return;
  
  try {
    const res = await fetch(`http://localhost:3000/events/${id}`, {
      method: 'DELETE'
    });
    
    if(res.ok) {
      alert('üóëÔ∏è √âv√©nement supprim√© avec succ√®s');
      loadEvents();
    } else {
      alert('‚ùå Erreur lors de la suppression');
    }
  } catch(err) {
    console.error(err);
    alert('‚ùå Erreur de connexion');
  }
}

// ===== CHATBOT =====
const chatbox = document.getElementById('chatbox');
const questionInput = document.getElementById('question');

function addMsg(txt, type) {
  const icon = type === 'bot' ? 'ü§ñ' : 'üë§';
  chatbox.innerHTML += `
    <div class="msg ${type}">
      ${type === 'bot' ? '<span class="icon">' + icon + '</span>' : ''}
      <div class="bubble">${txt}</div>
      ${type === 'user' ? '<span class="icon">' + icon + '</span>' : ''}
    </div>
  `;
  chatbox.scrollTop = chatbox.scrollHeight;
}

function askBot() {
  const q = questionInput.value.trim();
  if (!q) return;
  
  addMsg(q, "user");
  questionInput.value = "";

  if(!selectedEvent) {
    // L'utilisateur doit choisir l'√©v√©nement par son titre
    const ev = eventsList.find(e => e.titre.toLowerCase() === q.toLowerCase());
    if(ev) {
      selectedEvent = ev;
      addMsg(`√âv√©nement "${selectedEvent.titre}" s√©lectionn√©. Vous pouvez maintenant poser des questions sur sa date, lieu ou description.`, "bot");
    } else {
      addMsg(`Je n'ai trouv√© aucun √©v√©nement nomm√© "${q}". Veuillez r√©essayer en donnant le nom exact.`, "bot");
    }
    return;
  }

  // Une fois l'√©v√©nement choisi, r√©pondre aux questions
  let response = "Je ne dispose pas de cette information.";
  const lq = q.toLowerCase();
  
  if(lq.includes("date")) response = `La date de l'√©v√©nement est : ${selectedEvent.date}`;
  else if(lq.includes("lieu")) response = `Le lieu de l'√©v√©nement est : ${selectedEvent.lieu}`;
  else if(lq.includes("titre")) response = `Le titre de l'√©v√©nement est : ${selectedEvent.titre}`;
  else if(lq.includes("description")) response = `Description : ${selectedEvent.description}`;
  else if(lq.includes("adresse")) response = `Adresse : ${selectedEvent.adresse}`;
  else if(lq.includes("changer") || lq.includes("autre")) {
    selectedEvent = null;
    response = "D'accord ! Quel √©v√©nement voulez-vous interroger maintenant ?";
  }

  addMsg(response, "bot");
}

// ===== INITIALISATION AU CHARGEMENT =====
window.addEventListener('DOMContentLoaded', loadEvents);
</script>

</body>
</html>
